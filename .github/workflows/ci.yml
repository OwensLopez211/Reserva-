name: ReservaPlus CI/CD

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

jobs:
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    # âœ… CLAVE: Configurar directorio de trabajo
    defaults:
      run:
        working-directory: reservaplus-backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        # âœ… CLAVE: Especificar ruta del package-lock.json
        cache-dependency-path: 'reservaplus-backend/package-lock.json'
        
    - name: ğŸ“¥ Install dependencies (cached)
      run: npm ci
      
    - name: ğŸ”§ TypeScript compilation check
      run: npx tsc --noEmit
      
    - name: ğŸ” ESLint check (if configured)
      run: npm run lint:check || npm run lint || echo "âš ï¸ ESLint not configured"
      continue-on-error: true
      
    - name: ğŸ¨ Prettier format check (if configured) 
      run: npm run format:check || echo "âš ï¸ Prettier not configured"
      continue-on-error: true

  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality
    
    defaults:
      run:
        working-directory: reservaplus-backend
    
    strategy:
      matrix:
        test-group: 
          - auth
          - users
          - app
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'reservaplus-backend/package-lock.json'
        
    - name: ğŸ“¥ Install dependencies (cached)
      run: npm ci
      
    - name: ğŸ§ª Run ${{ matrix.test-group }} tests
      run: |
        if [ "${{ matrix.test-group }}" = "app" ]; then
          npm run test -- --testPathPattern="app\." --coverage
        else
          npm run test -- --testPathPattern="${{ matrix.test-group }}" --coverage
        fi

  coverage:
    name: ğŸ“Š Coverage Report
    runs-on: ubuntu-latest
    needs: test
    
    defaults:
      run:
        working-directory: reservaplus-backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'reservaplus-backend/package-lock.json'
        
    - name: ğŸ“¥ Install dependencies (cached)
      run: npm ci
      
    - name: ğŸ§ª Run full test suite with coverage
      run: npm run test:cov
      
    - name: ğŸ“ˆ Coverage Summary
      run: |
        echo "ğŸ“Š COVERAGE SUMMARY:"
        if [ -f coverage/coverage-summary.json ]; then
          cat coverage/coverage-summary.json
        else
          echo "Coverage summary not found, but tests ran successfully"
        fi

  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [quality, test]
    
    defaults:
      run:
        working-directory: reservaplus-backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'reservaplus-backend/package-lock.json'
        
    - name: ğŸ“¥ Install dependencies (cached)
      run: npm ci
      
    - name: ğŸ—ï¸ Build application
      run: npm run build
      
    - name: ğŸ“¦ Archive build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist-files
        path: reservaplus-backend/dist/
        retention-days: 7
        
    - name: ğŸ“Š Build size analysis
      run: |
        echo "ğŸ“¦ BUILD SIZE ANALYSIS:"
        du -sh dist/ || echo "Build directory not found"
        echo "âœ… Build completed successfully"

  success:
    name: âœ… Pipeline Success
    runs-on: ubuntu-latest
    needs: [coverage, build]
    if: success()
    
    steps:
    - name: ğŸ‰ Success notification
      run: |
        echo "ğŸ‰ Â¡Pipeline completado exitosamente!"
        echo "âœ… Calidad de cÃ³digo: PASSED"
        echo "âœ… Tests: PASSED" 
        echo "âœ… Coverage: PASSED"
        echo "âœ… Build: PASSED"
        echo ""
        echo "ğŸš€ Â¡Listo para deploy!"