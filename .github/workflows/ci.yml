name: ReservaPlus CI/CD

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]

jobs:
  # ================================
  # JOB 1: QUALITY GATES
  # ================================
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'  # âœ… AHORA SÃ PODEMOS USAR CACHE
        
    - name: ğŸ“¥ Install dependencies (fast with cache)
      run: npm ci  # âœ… npm ci es mÃ¡s rÃ¡pido y determinÃ­stico
      
    - name: ğŸ”§ TypeScript compilation check
      run: npx tsc --noEmit
      
    - name: ğŸ” ESLint check (if configured)
      run: npm run lint:check || npm run lint || echo "âš ï¸ ESLint not configured"
      continue-on-error: true
      
    - name: ğŸ¨ Prettier format check (if configured) 
      run: npm run format:check || echo "âš ï¸ Prettier not configured"
      continue-on-error: true

  # ================================
  # JOB 2: TESTS (PARALLEL BY MODULE)
  # ================================
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality
    
    strategy:
      matrix:
        test-group: 
          - auth
          - users
          - app
          # - organizations  # Add as you create modules
          # - professionals
          # - appointments
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies (cached)
      run: npm ci
      
    - name: ğŸ§ª Run ${{ matrix.test-group }} tests
      run: |
        if [ "${{ matrix.test-group }}" = "app" ]; then
          npm run test -- --testPathPattern="app\." --coverage
        else
          npm run test -- --testPathPattern="${{ matrix.test-group }}" --coverage
        fi
      
    - name: ğŸ“Š Upload coverage for ${{ matrix.test-group }}
      uses: actions/upload-artifact@v3
      with:
        name: coverage-${{ matrix.test-group }}
        path: coverage/
        retention-days: 3

  # ================================
  # JOB 3: COVERAGE REPORT
  # ================================
  coverage:
    name: ğŸ“Š Coverage Report
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies (cached)
      run: npm ci
      
    - name: ğŸ§ª Run full test suite with coverage
      run: npm run test:cov
      
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: reservaplus-coverage
        fail_ci_if_error: false
      continue-on-error: true
      
    - name: ğŸ“ˆ Coverage Summary
      run: |
        echo "ğŸ“Š COVERAGE SUMMARY:"
        cat coverage/coverage-summary.json | jq '.total'
        echo ""
        echo "ğŸ“‹ DETAILED COVERAGE:"
        npm run test:cov -- --silent | grep -E "(File|All files|---|%)"

  # ================================
  # JOB 4: BUILD
  # ================================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [quality, test]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies (cached)
      run: npm ci
      
    - name: ğŸ—ï¸ Build application
      run: npm run build
      
    - name: ğŸ“¦ Archive build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist-files
        path: dist/
        retention-days: 7
        
    - name: ğŸ“Š Build size analysis
      run: |
        echo "ğŸ“¦ BUILD SIZE ANALYSIS:"
        du -sh dist/
        echo ""
        echo "ğŸ“‹ LARGEST FILES:"
        find dist/ -type f -exec du -h {} + | sort -rh | head -10

  # ================================
  # JOB 5: SECURITY AUDIT (OPTIONAL)
  # ================================
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¥ Install dependencies (cached)
      run: npm ci
      
    - name: ğŸ”’ Run npm audit
      run: npm audit --audit-level moderate
      continue-on-error: true
      
    - name: ğŸ›¡ï¸ Security summary
      run: |
        echo "ğŸ”’ SECURITY AUDIT SUMMARY:"
        npm audit --audit-level low --parseable | wc -l
        echo "vulnerabilities found (low level)"

  # ================================
  # JOB 6: SUCCESS NOTIFICATION
  # ================================
  success:
    name: âœ… Pipeline Success
    runs-on: ubuntu-latest
    needs: [coverage, build, security]
    if: success()
    
    steps:
    - name: ğŸ‰ Success notification
      run: |
        echo "ğŸ‰ Â¡Pipeline completado exitosamente!"
        echo "âœ… Calidad de cÃ³digo: PASSED"
        echo "âœ… Tests: PASSED" 
        echo "âœ… Coverage: PASSED"
        echo "âœ… Build: PASSED"
        echo "âœ… Security: PASSED"
        echo ""
        echo "ğŸš€ Â¡Listo para deploy!"